services:
  api:
    image: registry.gitlab.com/jerejunttila/kulku-api:stable
    restart: unless-stopped
    volumes:
       - /var/www/holdion/cert:/https:ro
    environment:
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/fullchain.pem
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=/run/secrets/default-conn
      - ConnectionStrings__UserConnection=/run/secrets/user-conn
    ports:
      - 7219:7219
      - 5144:5144
    secrets:
      - default-conn
      - user-conn
  admin:
    image: registry.gitlab.com/jerejunttila/kulku-admin:stable
    restart: unless-stopped
    volumes:
       - /var/www/holdion/cert:/https:ro
    environment:
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/fullchain.pem
      - ASPNETCORE_ENVIRONMENT=Production
      - ForceHttps
      - AllowedHosts
      - ASPNETCORE_FORWARDEDHEADERS_ENABLED
      - ConnectionStrings__DefaultConnection=/run/secrets/default-conn
      - ConnectionStrings__UserConnection=/run/secrets/user-conn
    ports:
      - 7215:7215
      - 5090:5090
    secrets:
      - default-conn
      - user-conn
  client:
    image: registry.gitlab.com/jerejunttila/kulku-client:stable
    restart: unless-stopped
    volumes:
       - /var/www/holdion/cert:/https:ro
    environment:
      - NEXT_PUBLIC_API_BASE_URL
      - NEXT_PUBLIC_RECAPTCHA_SITE_KEY
    ports:
      - 8085:3000
    depends_on:
      - api

secrets:
  default-conn:
    file: /var/www/jerejunttila/secrets/default-conn.txt
  user-conn:
    file: /var/www/jerejunttila/secrets/user-conn.txt